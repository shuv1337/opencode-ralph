#!/usr/bin/env node
import { spawn } from "node:child_process";
import fs from "node:fs";
import os from "node:os";
import path from "node:path";
import { createRequire } from "node:module";
import { fileURLToPath } from "node:url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const require = createRequire(import.meta.url);
const projectRoot = path.resolve(__dirname, "..");

const platformMap = {
  darwin: "darwin",
  linux: "linux",
  win32: "windows",
};

const archMap = {
  x64: "x64",
  arm64: "arm64",
};

const platform = platformMap[os.platform()] ?? os.platform();
const arch = archMap[os.arch()] ?? os.arch();
const packageName = `openralph-${platform}-${arch}`;
const binaryName = platform === "windows" ? "ralph.exe" : "ralph";

let binaryPath;

// First, check for locally built binary in dist/ directory
const localBinaryPath = path.join(projectRoot, "dist", packageName, "bin", binaryName);
if (fs.existsSync(localBinaryPath)) {
  binaryPath = localBinaryPath;
} else {
  // Fall back to npm package resolution for installed packages
  try {
    const packageJsonPath = require.resolve(`${packageName}/package.json`);
    const packageDir = path.dirname(packageJsonPath);
    binaryPath = path.join(packageDir, "bin", binaryName);
  } catch (error) {
    // No local build and no npm package found
    console.error(`Error: No ralph binary found for ${platform}-${arch}.`);
    console.error("");
    console.error("To fix this, run:");
    console.error("  bun run build:single   # Build for current platform");
    console.error("");
    console.error("Or install globally:");
    console.error("  bun install -g openralph");
    process.exit(1);
  }
}

if (!fs.existsSync(binaryPath)) {
  console.error(`Error: Binary not found at ${binaryPath}`);
  console.error("");
  console.error("To fix this, run:");
  console.error("  bun run build:single   # Rebuild for current platform");
  process.exit(1);
}

const child = spawn(binaryPath, process.argv.slice(2), { stdio: "inherit" });
child.on("exit", (code) => {
  process.exit(code ?? 0);
});
child.on("error", (error) => {
  console.error(`Failed to run ${binaryName}: ${error.message}`);
  process.exit(1);
});
